# Task Breakdown: Go Code Generation Feature (v1.1.0)

**Strategy:** In-place evolution of `pkg/cgocopy`  
**Timeline:** 4 weeks  
**Priority:** P0 = Critical path, P1 = Important, P2 = Nice to have

---

## Week 1: Core Go Generation

### Task 1.1: CLI Extension (P0)
**File:** `tools/cgocopy-generate/main.go`  
**Estimate:** 2 hours

- [ ] Add `-go` flag (enable Go generation)
- [ ] Add `-go-output` flag (output directory, default: same as -output)
- [ ] Add `-go-package` flag (package name, default: infer from dir)
- [ ] Update help text
- [ ] Add validation (can't use -go without -input)

**Acceptance:**
```bash
$ cgocopy-generate -input bridge.h -go -go-package bridge
✓ Generates bridge_types.go
✓ Generates bridge_meta.c (existing)
```

---

### Task 1.2: Type Mapping System (P0)
**File:** `tools/cgocopy-generate/type_mapping.go` (NEW)  
**Estimate:** 3 hours

- [ ] Create type mapping table:
  ```go
  var cToGoType = map[string]string{
      "int8_t": "int8",
      "uint32_t": "uint32",
      "char*": "string",  // with IsString flag
      // ... all C types
  }
  ```
- [ ] Implement `MapCTypeToGo(cType string) (goType string, isString bool)`
- [ ] Handle arrays: `int[5]` → `[5]int`
- [ ] Handle pointers: `Device*` → `*Device` (nested) or `uintptr` (opaque)
- [ ] Unit tests for all type mappings

**Acceptance:**
```go
MapCTypeToGo("int32_t") == ("int32", false)
MapCTypeToGo("char*") == ("string", true)
MapCTypeToGo("Device*") == ("*Device", false)
```

---

### Task 1.3: Name Conversion (P0)
**File:** `tools/cgocopy-generate/name_conversion.go` (NEW)  
**Estimate:** 2 hours

- [ ] Implement `ToGoName(cName string) string`:
  ```go
  "user_id" → "UserID"
  "http_url" → "HTTPURL"  // Handle acronyms
  "type" → "Type_"  // Handle Go keywords
  ```
- [ ] Go keyword detection
- [ ] Acronym handling (HTTP, URL, ID, etc.)
- [ ] Unit tests for edge cases

**Acceptance:**
```go
ToGoName("user_id") == "UserID"
ToGoName("http_proxy") == "HTTPProxy"
ToGoName("type") == "Type_"
```

---

### Task 1.4: Go Struct Template (P0)
**File:** `tools/cgocopy-generate/go_templates.go` (NEW)  
**Estimate:** 3 hours

- [ ] Create struct template:
  ```go
  const goStructTemplate = `
  type {{.Name}} struct {
      {{range .Fields}}
      {{.GoName}} {{.GoType}} {{.Tags}}
      {{end}}
  }
  `
  ```
- [ ] Create preamble template (package, imports)
- [ ] Implement template rendering
- [ ] Add comments (generated by cgocopy-generate)

**Acceptance:**
```go
// Generated output:
package bridge

type User struct {
    UserID   int32  `cgocopy:"user_id"`
    Username string `cgocopy:"username"`
}
```

---

### Task 1.5: Go Generator Orchestration (P0)
**File:** `tools/cgocopy-generate/go_generator.go` (NEW)  
**Estimate:** 4 hours

- [ ] Create `GenerateGoCode(structs []ParsedStruct, pkg string) (string, error)`
- [ ] Use existing parser (reuse C parsing logic)
- [ ] Apply type mapping to each field
- [ ] Apply name conversion to struct + field names
- [ ] Render templates
- [ ] Write output file
- [ ] Integration test (parse + generate)

**Acceptance:**
```bash
$ cgocopy-generate -input test.h -go -go-package test
✓ Compiles without errors
✓ go vet passes
✓ go fmt is happy
```

**Deliverable:** Can generate basic Go structs from C headers (primitives only)

---

## Week 1-2: Registration & Validation

### Task 2.1: Init Function Template (P0)
**File:** `tools/cgocopy-generate/go_templates.go`  
**Estimate:** 3 hours

- [ ] Create init template:
  ```go
  func init() {
      cgocopy.PrecompileWithC[{{.Name}}](cgocopy.CStructInfo{
          Name: "{{.CName}}",
          Size: unsafe.Sizeof({{.Name}}{}),
          Fields: []cgocopy.CFieldInfo{
              {{range .Fields}}
              {
                  Name: "{{.CName}}",
                  Type: "{{.CType}}",
                  Offset: {{.Offset}},
                  Size: {{.Size}},
                  IsArray: {{.IsArray}},
                  ArrayLen: {{.ArrayLen}},
                  IsString: {{.IsString}},
              },
              {{end}}
          },
      })
  }
  ```
- [ ] Generate for all structs
- [ ] Handle dependency order (nested structs registered first)

**Acceptance:**
```go
// Generated code auto-registers types
import _ "myproject/bridge"  // init() runs automatically
user := cgocopy.Copy[bridge.User](cPtr)  // Works immediately!
```

---

### Task 2.2: Metadata Extraction (P0)
**File:** `tools/cgocopy-generate/go_templates.go`  
**Estimate:** 2 hours

- [ ] Generate helper to extract C metadata:
  ```go
  func extractUserMetadata() cgocopy.CStructInfo {
      cInfo := C.cgocopy_get_User_info()
      return cgocopy.CStructInfo{
          Name: C.GoString(cInfo.name),
          Size: uintptr(cInfo.size),
          // ... convert all fields
      }
  }
  ```
- [ ] Use in init() for runtime validation
- [ ] Compare against Go struct size/layout

**Acceptance:**
- ✓ Runtime validation catches mismatches
- ✓ Errors are clear ("Size mismatch: Go=24, C=28")

---

## Week 2: String Support

### Task 3.1: String Conversion Helper (P0)
**File:** `pkg/cgocopy/string_helpers.go` (NEW)  
**Estimate:** 2 hours

- [ ] Implement `convertCString(ptr unsafe.Pointer, maxLen int) string`
- [ ] Handle null terminators
- [ ] Handle null pointers (return "")
- [ ] Handle fixed arrays (char[64])
- [ ] Handle pointers (char*)
- [ ] Unit tests

**Acceptance:**
```go
convertCString(ptr, 64) == "Hello, World!"
convertCString(nil, 64) == ""
```

---

### Task 3.2: Extend CFieldInfo (P0)
**File:** `pkg/cgocopy/types.go`  
**Estimate:** 30 minutes

- [ ] Add `IsString bool` field to CFieldInfo
- [ ] Update documentation
- [ ] Update tests

**Acceptance:**
- ✓ Backward compatible (zero value = false)
- ✓ All existing tests pass

---

### Task 3.3: Integrate String Conversion (P0)
**File:** `pkg/cgocopy/copy.go`  
**Estimate:** 2 hours

- [ ] Check `field.IsString` in copy logic
- [ ] Call `convertCString` when true
- [ ] Set Go string field value
- [ ] Handle errors gracefully
- [ ] Add tests

**Acceptance:**
```go
type User struct {
    Name string  // Auto-converted from char*
}
user := cgocopy.Copy[User](cPtr)
assert(user.Name == "John Doe")
```

---

### Task 3.4: Generate String Fields (P0)
**File:** `tools/cgocopy-generate/go_generator.go`  
**Estimate:** 2 hours

- [ ] Detect char* in C → string in Go
- [ ] Detect char[N] in C → string in Go (with maxLen)
- [ ] Set IsString=true in generated metadata
- [ ] Add integration test

**Acceptance:**
```c
// C code:
typedef struct {
    char* name;
    char label[64];
} Item;

// Generated Go code:
type Item struct {
    Name  string `cgocopy:"name"`
    Label string `cgocopy:"label"`
}
```

**Deliverable:** Full string support (char* and char[])

---

## Week 2-3: Arrays & Nested Structs

### Task 4.1: Fixed Array Generation (P0)
**File:** `tools/cgocopy-generate/go_generator.go`  
**Estimate:** 2 hours

- [ ] Detect C arrays: `int values[10]`
- [ ] Generate Go arrays: `Values [10]int`
- [ ] Set IsArray=true, ArrayLen=10
- [ ] Test with various element types

**Acceptance:**
```c
// C:
int grades[5];

// Go:
Grades [5]int32
```

---

### Task 4.2: Dependency Sorting (P0)
**File:** `tools/cgocopy-generate/dependency_sort.go` (NEW)  
**Estimate:** 3 hours

- [ ] Implement topological sort (Kahn's algorithm)
- [ ] Build dependency graph (struct → nested struct types)
- [ ] Sort structs by dependencies
- [ ] Detect circular dependencies
- [ ] Unit tests with complex graphs

**Acceptance:**
```c
// C code:
typedef struct { double x, y; } Point;
typedef struct { Point pos; } Object;

// Go code (correct order):
type Point struct { X, Y float64 }
type Object struct { Pos Point }
```

---

### Task 4.3: Nested Struct Generation (P0)
**File:** `tools/cgocopy-generate/go_generator.go`  
**Estimate:** 2 hours

- [ ] Detect nested struct fields
- [ ] Generate in correct order (dependency sort)
- [ ] Handle multiple levels of nesting
- [ ] Integration test

**Acceptance:**
- ✓ Deep nesting (3+ levels) works
- ✓ Circular deps give clear error

**Deliverable:** Arrays and nested structs fully supported

---

## Week 3: Dynamic Arrays (OPTIONAL - P1)

### Task 5.1: Pattern Detection (P1)
**File:** `tools/cgocopy-generate/pattern_detection.go` (NEW)  
**Estimate:** 4 hours

- [ ] Detect {count, data*} pattern:
  ```c
  int32_t device_count;
  Device* devices;
  ```
- [ ] Heuristics: field names, proximity, types
- [ ] Handle variations (count_devices, deviceCount, num_devices)
- [ ] False positive detection

**Acceptance:**
- ✓ Detects 90% of standard patterns
- ✓ Allows manual override via comment annotation

---

### Task 5.2: Dynamic Array Helpers (P1)
**File:** `pkg/cgocopy/array_helpers.go` (NEW)  
**Estimate:** 2 hours

- [ ] Implement `createDynamicSlice[T any](dataPtr unsafe.Pointer, count int32) []T`
- [ ] Use unsafe.Slice (zero-copy)
- [ ] Handle count=0 (return nil slice)
- [ ] Handle dataPtr=nil (return nil slice)
- [ ] Benchmark (target: <1ns)

**Acceptance:**
- ✓ Performance: 0.32ns overhead
- ✓ Zero-copy (no allocation)

---

### Task 5.3: Generate Dynamic Arrays (P1)
**File:** `tools/cgocopy-generate/go_generator.go`  
**Estimate:** 3 hours

- [ ] Generate slice fields:
  ```go
  type DeviceList struct {
      DeviceCount int32
      Devices     []Device  // Populated from count
  }
  ```
- [ ] Set IsDynamic=true, CountField="DeviceCount"
- [ ] Integration test

**Acceptance:**
- ✓ Pattern detected and generated correctly
- ✓ Runtime copies data correctly

**Note:** Can defer to v1.2 if too complex

---

## Week 3-4: Edge Cases & Polish

### Task 6.1: Go Keyword Handling (P1)
**File:** `tools/cgocopy-generate/name_conversion.go`  
**Estimate:** 1 hour

- [ ] Detect all Go keywords
- [ ] Append underscore: `type → Type_`
- [ ] Add to unit tests

---

### Task 6.2: Name Collision Detection (P1)
**File:** `tools/cgocopy-generate/go_generator.go`  
**Estimate:** 2 hours

- [ ] Detect when multiple C structs map to same Go name
- [ ] Warn user with clear message
- [ ] Suggest manual rename

---

### Task 6.3: Comment Preservation (P2)
**File:** `tools/cgocopy-generate/parser.go`  
**Estimate:** 3 hours

- [ ] Extract comments from C code
- [ ] Attach to structs/fields
- [ ] Include in generated Go code

---

### Task 6.4: Better Error Messages (P1)
**File:** `tools/cgocopy-generate/*.go`  
**Estimate:** 2 hours

- [ ] Improve all error messages
- [ ] Include file:line context
- [ ] Suggest fixes
- [ ] Add examples

---

## Week 4: Documentation, Testing, Release

### Task 7.1: Update Main README (P0)
**File:** `pkg/cgocopy/README.md`  
**Estimate:** 2 hours

- [ ] Add Go generation section
- [ ] Show before/after examples
- [ ] Document workflow (go generate)
- [ ] Performance benchmarks table

---

### Task 7.2: Create Example: Simple Bridge (P0)
**File:** `examples/simple_bridge/` (NEW)  
**Estimate:** 3 hours

- [ ] Simple C header (User struct)
- [ ] Generated Go code
- [ ] README with step-by-step
- [ ] Makefile

---

### Task 7.3: Create Example: Audio Engine (P1)
**File:** `examples/audio_bridge/` (NEW)  
**Estimate:** 4 hours

- [ ] Real-world C library
- [ ] Complex structs (nested, arrays)
- [ ] Complete working demo
- [ ] Performance comparison

---

### Task 7.4: Write Migration Guide (P1)
**File:** `docs/guides/migration_v1.0_to_v1.1.md` (NEW)  
**Estimate:** 2 hours

- [ ] What's new in v1.1
- [ ] How to adopt Go generation
- [ ] Backward compatibility notes
- [ ] Common migration patterns

---

### Task 8.1: Tool Unit Tests (P0)
**File:** `tools/cgocopy-generate/*_test.go`  
**Estimate:** 4 hours

- [ ] Type mapping tests
- [ ] Name conversion tests
- [ ] Dependency sort tests
- [ ] Parser tests
- [ ] Generator tests

**Target:** 90% coverage

---

### Task 8.2: Runtime Tests (P0)
**File:** `pkg/cgocopy/*_test.go`  
**Estimate:** 3 hours

- [ ] String conversion tests
- [ ] Array tests
- [ ] Integration tests (generated code)
- [ ] Benchmark tests (no regression)

**Target:** No performance regression vs v1.0.0

---

### Task 8.3: Integration Test Suite (P0)
**File:** `tests/integration/` (NEW)  
**Estimate:** 4 hours

- [ ] Generate code from test headers
- [ ] Compile and run
- [ ] Validate results
- [ ] CI/CD integration

---

### Task 8.4: Platform Tests (P1)
**Estimate:** 2 hours

- [ ] Test on Linux (x86_64, ARM64)
- [ ] Test on macOS (x86_64, ARM64)
- [ ] Test on Windows (x86_64)
- [ ] Document any platform-specific issues

---

### Task 9.1: Release v1.1.0 (P0)
**Estimate:** 2 hours

- [ ] Final code review
- [ ] Update CHANGELOG.md
- [ ] Update version numbers
- [ ] Tag release: `git tag v1.1.0`
- [ ] Push to GitHub
- [ ] Verify pkg.go.dev updates

---

### Task 9.2: Release Announcement (P1)
**Estimate:** 2 hours

- [ ] Write release notes
- [ ] Announce on GitHub Discussions
- [ ] Post to r/golang
- [ ] Post to Twitter/X
- [ ] Update project website (if any)

---

## Task Summary

| Week | Tasks | LOC | Priority | Risk |
|------|-------|-----|----------|------|
| 1 | Core generation (1.1-1.5) | ~400 | P0 | LOW |
| 1-2 | Registration (2.1-2.2) | ~200 | P0 | LOW |
| 2 | String support (3.1-3.4) | ~150 | P0 | LOW |
| 2-3 | Arrays/nested (4.1-4.3) | ~250 | P0 | LOW |
| 3 | Dynamic arrays (5.1-5.3) | ~200 | P1 | MED |
| 3-4 | Polish (6.1-6.4) | ~150 | P1 | LOW |
| 4 | Docs (7.1-7.4) | ~0 | P0 | ZERO |
| 4 | Testing (8.1-8.4) | ~300 | P0 | LOW |
| 4 | Release (9.1-9.2) | ~0 | P0 | ZERO |
| **Total** | **30 tasks** | **~1650 LOC** | - | - |

**Critical path:** Tasks 1.1 → 1.5 → 2.1 → 3.1-3.4 → 4.1-4.3 → 8.1-8.3 → 9.1

**Can defer to v1.2:** Task 5 (dynamic arrays), Task 6.3 (comments), Task 7.3 (audio example)

---

## Next Actions

1. **Review this breakdown** - Agree on priorities and scope
2. **Start with Task 1.1** - CLI extension (2 hours, low risk)
3. **Set up project board** - Track progress (GitHub Projects or similar)
4. **Daily standup** - 15 min check-ins during active development

**Ready to start?** Let's tackle Task 1.1 first! 🚀
